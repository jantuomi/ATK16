@opt stack_pointer RG
@opt csr_scratch RH
@use ext_std:*
@let vector_table 0x10
@let vt_ISR0 0x10
@let vt_ISR1 0x11
@let vt_ISR2 0x12
@let vt_ISR3 0x13
@let vt_stack_addr 0x14
@let vt_term_pp_addr 0x15
@let vt_kb_pp_addr 0x16
@let vt_gr_mode_addr 0x17
@let vt_sprite_mem 0x18
@let vt_text_mem 0x19
@let stack_segment 0x8000
@let mmio_segment 0xE000
@let terminal_addr 0xE000
@let keyboard_addr 0xE001
@let gr_mode_addr 0xE002
@let sprite_mem 0xE800
@let text_mem 0xF800
@let gr_disabled_mode 0b00
@let gr_text_mode 0b01
@let gr_sprite_mode 0b10
@address 0x0
  ldi vt_stack_addr RA
  ldr RA SP
  jpi program_segment
@address vector_table
  keyboard_isr
  hlt_isr
  hlt_isr
  hlt_isr
  stack_segment
  terminal_addr
  keyboard_addr
  gr_mode_addr
  sprite_mem
  text_mem
@label hlt_isr
  ldi 0x55 RE
  hlt
@label keyboard_isr
  spu RA
  spu RB
  ldi vt_kb_pp_addr RA
  ldr RA RA
  ldr RA RA
  ldi vt_term_pp_addr RB
  ldr RB RB
  str RA RB
  spo RB
  spo RA
  rti
@label program_segment
  ldi vt_gr_mode_addr RA
  ldr RA RA
  ldi gr_disabled_mode RB
  str RB RA
  jpi main
@label func
  addi SP 1 SP
  ldi ${SP - 3} RA
  ldr RA RA
  ldi ${SP - 1} RB
  str RA RB
  ldi ${SP - 1} RA
  ldr RA RA
  ldi ${SP - 1} RB
  ldr RB RB
  add RA RB RA
  spu RA
  subi SP 1 SP
  rsr
@label main
  addi SP 1 SP
  ldi 1 RA
  spu RA
  ldi 3 RA
  spu RA
  csi func
  spo RA
  ldi ${SP - 1} RB
  str RA RB
  subi SP 1 SP